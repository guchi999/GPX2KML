<!-- GPXã‹ã‚‰â„ªMLã¸ã®å¤‰æ› 20210312-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>GPX2â„ªML</title>
  <style>
	body { width: 90%; max-width: 900px; min-width: 480px; margin: 0 auto; }
  </style>
</head>
<body>
	[GPXâ†’â„ªMLå¤‰æ› V2.0]
	<br>
	<b>ç”»é¢ã«GPXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</b>
	<input type="file" multiple id="selfile">
	<br>
	<form name="entFil">
		<div>
			<label for="read_txt">å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆï¼§ï¼°ï¼¸ï¼‰</label> <br>
			<textarea name="read_txt" rows="10" cols="80" readonly></textarea><br>
		</div>
	</form>

	<form name="exprtFil">
		<div>
			<label for="wrt_txt">å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆï¼«ï¼­ï¼¬ï¼‰</label> <br>
			<textarea name="wrt_txt" rows="10" cols="80" readonly></textarea><br>
		</div>
	</form>

	<form name="selbttn1">
		<b style="color:#ff3d3d">ğŸ›</b>ãƒ©ã‚¤ãƒ³ã®è‰²:
		<input type="radio" name="color1" value="ff0000ff" onchange="mke_KLM()" checked> <span style="color:#ff0000"><b>èµ¤</b></span>
		<input type="radio" name="color1" value="ffff0000" onchange="mke_KLM()" > <span style="color:#0000ff"><b>é’</b></span>
		<input type="radio" name="color1" value="ffd355ba" onchange="mke_KLM()" > <span style="color:#ba55d3"><b>ç´«</b></span>
		<input type="radio" name="color1" value="ff000000" onchange="mke_KLM()" > <span style="color:#000000"><b>é»’</b></span>
		ã€€ã€€ã€€<b style="color:#ff3d3d">ğŸ›</b>ãƒ©ã‚¤ãƒ³ã®å¤ªã•:<input type="number" id="WoL" size="4"  min="0" max="10" value="3" style="width:3em;">
	</form>
	<form name="selbttn2">
		<b style="color:#ff3d3d">ğŸ›</b>ãƒˆãƒ©ãƒƒã‚¯ç«¯ãƒãƒ¼ã‚«ãƒ¼ï¼š
		<input type="radio" name="Icon" value="all" onchange="mke_KLM()"> å…¨ã¦è¡¨ç¤ºã™ã‚‹
		<input type="radio" name="Icon" value="se" onchange="mke_KLM()" checked> å§‹ç‚¹ã¨çµ‚ç‚¹ã®ã¿è¡¨ç¤º
		<input type="radio" name="Icon" value="no" onchange="mke_KLM()" > è¡¨ç¤ºã—ãªã„
	</form>
	<form name="selbttn3">
		<b style="color:#ff3d3d">ğŸ›</b>ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆ(åœ°å)ãƒãƒ¼ã‚«ãƒ¼ï¼š
		<input type="radio" name="Icon2" value="on" onchange="mke_KLM()" checked > è¡¨ç¤ºã™ã‚‹
		<input type="radio" name="Icon2" value="off" onchange="mke_KLM()" > è¡¨ç¤ºã—ãªã„
	</form>

	<br>
	<a id="getLocal" href="#" onClick="saveFile()">
	<span style="border: 1px solid #000000; background-color: #dcdcdc">å¤‰æ›ã—ãŸKMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</span></a>


<script>

var obj1 = document.getElementById("selfile");
var readTxt = ""; // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—åˆ—
var writeFilNam = ""; // æ‹¡å¼µå­ç„¡ã—ãƒ•ã‚¡ã‚¤ãƒ«å
var writeTex = ""; // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç”¨æ–‡å­—åˆ—
var pointer = 0; // æ¤œç´¢ç”¨ãƒã‚¤ãƒ³ã‚¿
var trkpArr = [0, ""]; // trkptArr = [pointer, "lon,lat,ele"]
var flgErr1 = 1; // ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°
var WpList = []; // ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆ(åœ°å)é…åˆ— [ [ name, lat, lon ], ... ]


//ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã‹ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ï¼‰
const dropArea = document.body; // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹é ˜åŸŸ
dropArea.addEventListener("dragover", event => {
	event.preventDefault();
	event.dataTransfer.dropEffect = "copy";
});
dropArea.addEventListener("drop", event => {
   event.preventDefault();
   var files = event.dataTransfer.files;
   getFiles(files);
});
function getFiles(files){
	for (let file of files){
		var reader = new FileReader();
		reader.readAsText(file); 
		reader.onload = event => {
			readTxt = event.target.result;
			writeFilNam = file.name.split(".")[0];
			after_file_read(readTxt, writeFilNam);
		}
	}
}
// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³å…¥åŠ›
var obj1 = document.getElementById("selfile");
obj1.addEventListener("change",function(evt){
	var file = evt.target.files;
  // ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—
	var input = document.querySelector("#selfile").files[0];
	var reader = new FileReader();  // FileReaderã®ä½œæˆ
	reader.readAsText(file[0]);  // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§èª­ã¿è¾¼ã‚€
  // èª­è¾¼çµ‚äº†å¾Œ
	reader.onload = function(){
		readTxt = reader.result; // èª­ã¿è¾¼ã‚“ã ãƒ†ã‚­ã‚¹ãƒˆã‚’ readTxt ã«å…¥ã‚Œã‚‹
		writeFilNam = input.name.split( "." )[0];
		after_file_read(readTxt, writeFilNam);
	 }
},false);

function after_file_read(readTxt, writeFilNam){
	document.entFil.read_txt.value = readTxt;  //ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
	let fieChk = 0;
	pointer = readTxt.indexOf("</gpx>");
	( pointer !== -1 ) ? fieChk = fieChk: fieChk++;
	pointer = readTxt.indexOf("<gpx");
	( pointer !== -1 ) ? fieChk = fieChk: fieChk++;
	if (fieChk === 0 ){
		make_Wplist(readTxt); // v20
		make_Wplist_byYR(readTxt); // v20
console.log(WpList);
		mke_KLM();
		flgErr1 = 0;
	}else{
		alert("ãƒ•ã‚¡ã‚¤ãƒ«1ã¯GPXãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
		flgErr1 = 1;
	}
}


function get_trkptLLE(entStr, pointer){
// æ–‡å­—åˆ—entStrã®pinterã®ä½ç½®ã‹ã‚‰<trkptã‚’æ¤œç´¢ã—trkptã®çµŒåº¦ã€ç·¯åº¦ã€æ¨™é«˜ã€åœ°åã‚’"Lon,Lat,Ele,strName"ã®æ–‡å­—åˆ—ã§è¿”ã™
// è¦‹ã¤ã‹ã‚‰ãªã„æ™‚pointerã¯-1ã€æ–‡å­—åˆ—ã¯ãƒ–ãƒ©ãƒ³ã‚¯ã€‚<ele>ã®ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„æ™‚ã¯ãƒ–ãƒ©ãƒ³ã‚¯
	pointer = entStr.indexOf("<trkpt",pointer);
	let strDat, strEle;
	if (pointer === -1){ return trkpArr = [pointer, ""]; }
	let trkptStr = entStr.substring(pointer, entStr.indexOf("</trkpt>",pointer)+8);
	let Latpt = trkptStr.indexOf("lat=");
	let Lonpt = trkptStr.indexOf("lon=");
	let strLat = trkptStr.substring( Latpt+5, trkptStr.indexOf('"', Latpt+5) );
	let strLon = trkptStr.substring( Lonpt+5, trkptStr.indexOf('"', Lonpt+5) );
	if ( trkptStr.indexOf("<ele>") != -1){
		strEle = trkptStr.substring(trkptStr.indexOf("<ele>")+5,trkptStr.indexOf("</ele>"));
		strDat = strLon +","+ strLat +","+ strEle;
	}else{
		strDat = strLon +","+ strLat +"," + 0; // v20 ã‚«ã‚·ãƒŸãƒ¼ãƒ«3dã‚¨ãƒ©ãƒ¼å¯¾ç­–
	}
	return trkpArr = [pointer, strDat];
}


function mke_KLM() {
 	if ( readTxt === "" ){ return; }
	let LinWid = document.getElementById("WoL").value; // ãƒ©ã‚¤ãƒ³å¹…
	let LinColor = document.selbttn1.color1.value; // ãƒ©ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼
	let iconSet = document.selbttn2.Icon.value; // ãƒˆãƒ©ãƒƒã‚¯å§‹çµ‚ãƒãƒ¼ã‚«ãƒ¼(ã‚¢ã‚¤ã‚³ãƒ³)è¡¨ç¤º
	let WpIcon = document.selbttn3.Icon2.value; // åœ°åãƒãƒ¼ã‚«ãƒ¼æœ‰ç„¡

  // ãƒ˜ãƒƒãƒ€ã¨ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®è¨˜è¿°
	writeTex = '<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n';
	writeTex += '  <Name>' + writeFilNam + '</Name>\n';
	writeTex += '  <Style id="L1">\n    <LineStyle>\n      <color>' + LinColor + '</color>\n';
	writeTex += '      <width>' + LinWid + '</width>\n';
	writeTex += '    </LineStyle>\n  </Style>\n';
  // ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆ(åœ°å)ã®è¨˜è¿° v20
	if (WpList.length != 0 && WpIcon === "on" ){
		writeTex += '  <Style id="WpIcon">\n    <IconStyle>\n      <Icon>\n';
		writeTex += '        <href>https://maps.gsi.go.jp/portal/sys/v4/symbols/609.png</href>\n      </Icon>\n';
		writeTex += '    <scale>1.0</scale>\n    </IconStyle>\n  </Style>\n';
		for ( let i = 0; i < WpList.length ; i++ ){
			writeTex += '  <Placemark>\n    <name>' + WpList[ i ][0] + '</name>\n';
			writeTex += '      <styleUrl>#WpIcon</styleUrl>\n';
			writeTex += '    <Point>\n      <altitudeMode>relativeToGround</altitudeMode>\n';
			writeTex += '      <coordinates>' + WpList[ i ][2] + ',' + WpList[ i ][1] + '</coordinates>\n';
			writeTex += '    </Point>\n   </Placemark>\n';
		}
	}
 // ãƒˆãƒ©ãƒƒã‚¯æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ãƒˆãƒ©ãƒƒã‚¯åã¨ãƒŠãƒ³ãƒãƒ¼ã®é…åˆ—ã‚’ä½œæˆ
	pointer = 0;
	let NofTrk = 0;
	let trkName = ""; let NumName = ""
	let trkNamArr = []; let NumArr =[];
	do {
		pointer = readTxt.indexOf("<trk>", pointer +1);
		if ( pointer !== -1 ) {
			NofTrk++;
			pointer = readTxt.indexOf("<name>", pointer);
			(pointer !== -1) ? trkName = readTxt.substring( pointer +6, readTxt.indexOf("</name>",pointer) ): trkName = "";
			trkNamArr.push(trkName);
			pointer = readTxt.indexOf("<number>", pointer);
			(pointer !== -1) ? NumName = readTxt.substring( pointer +8, readTxt.indexOf("</number>",pointer) ): NumName ="";
			NumArr.push(NumName);
		}
	} while ( pointer !== -1 );

  // å„ãƒˆãƒ©ãƒƒã‚¯ã®ãƒãƒ¼ã‚«ãƒ¼è¨­å®šåˆ¤å®šç”¨ãƒ•ãƒ©ã‚°é…åˆ—
	let trkFlg = "";
	let trkFlgArr =[];
	if ( NofTrk === 1){
		trkFlgArr.push("b");
	}else{
		for ( let i = 0; i < NofTrk; i++ ) {
			trkFlg = "b";
			if ( i + 1 < NofTrk && trkNamArr[i] === trkNamArr[i+1] ){
					trkFlg = "s";
					if ( i != 0 && trkNamArr[i] === trkNamArr[i-1] ){
						trkFlg = "m";
					}
			}else if ( i != 0 &&  trkNamArr[i] === trkNamArr[i-1] ){
				trkFlg = "e";
			}
			if ( i + 1 == NofTrk ){
				( trkNamArr[i] === trkNamArr[i-1] ) ? trkFlg = "e": trkFlg = trkFlg;
			}
			trkFlgArr.push(trkFlg);
		}
	}
  // ãƒˆãƒ©ãƒƒã‚¯åãŒåŒã˜å ´åˆã¯<number>ã®å€¤ã‚’ä»˜åŠ ã—ãŸã‚‚ã®ã‚’ãƒˆãƒ©ãƒƒã‚¯åã¨ã™ã‚‹
	for ( let i = 0; i < NofTrk; i++ ) {
		if ( trkFlgArr[i] != "b" ){
			trkNamArr[i] = trkNamArr[i] + NumArr[i];
		}
	}

 // 1ãƒˆãƒ©ãƒƒã‚¯åˆ†ã®æ–‡å­—åˆ—ã‚’åˆ‡ã‚Šå‡ºã—ã€ãã®æ–‡å­—åˆ—ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è¨˜è¿°ã‚’ä½œæˆ
	pointer = 0;
	for (let i = 0; i < NofTrk; i++ ) {
		pointer = readTxt.indexOf("<trk>", pointer +1);
		let strTrk = readTxt.substring( pointer, readTxt.indexOf("</trk>",pointer) );
  // ãƒˆãƒ©ãƒƒã‚¯å§‹çµ‚ãƒãƒ¼ã‚«ãƒ¼è¨˜è¿°
		if ( iconSet !== "no" ){
			get_trkptLLE(strTrk, 0);
			let strIcSp = trkpArr[1];
			get_trkptLLE( strTrk, strTrk.lastIndexOf( "<trkpt" ) -1 );
			let strIcEp = trkpArr[1];
			if ( iconSet == "all" || trkFlgArr[i] == "s" || trkFlgArr[i] == "b" ){
				writeTex += '  <Placemark>\n    <name>' + trkNamArr[i] + ' Start</name>\n';
				writeTex += '    <Point>\n      <altitudeMode>relativeToGround</altitudeMode>\n';
				writeTex += '      <coordinates>' + strIcSp + '</coordinates>\n';
				writeTex += '    </Point>\n   </Placemark>\n';
			}
			if ( iconSet == "all" || trkFlgArr[i] == "e" || trkFlgArr[i] == "b" ){
				writeTex += '  <Placemark>\n    <name>' + trkNamArr[i] + ' End</name>\n';
				writeTex += '    <Point>\n      <altitudeMode>relativeToGround</altitudeMode>\n';
				writeTex += '      <coordinates>' + strIcEp + '</coordinates>\n';
				writeTex += '    </Point>\n   </Placemark>\n';
			}
		}
 // ãƒ©ã‚¤ãƒ³ã®è¨˜è¿°
		writeTex += '  <Placemark>\n    <name>' + trkNamArr[i] + '</name>\n';
		writeTex += '    <styleUrl>#L1</styleUrl>\n    <LineString>\n      <altitudeMode></altitudeMode>\n      <coordinates>\n';
		let SubPointer = 0;
		do { // ãƒ©ã‚¤ãƒ³ç”¨ç·¯åº¦çµŒåº¦æ–‡å­—åˆ—ç”Ÿæˆ
			get_trkptLLE(strTrk, SubPointer +1 );
			SubPointer = trkpArr[0];
			if ( SubPointer !== -1 ){
				writeTex +=  trkpArr[1] + " \n";
			}
		} while ( SubPointer !== -1 );
		writeTex += '      </coordinates>\n    </LineString>\n  </Placemark>\n';
	}
 // ãƒ•ãƒƒã‚¿ãƒ¼
	writeTex += '</Document>\n</kml>\n';
	document.exprtFil.wrt_txt.value = writeTex;  //KMLæ–‡å­—åˆ—ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
}


function saveFile() {
// ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
	if (flgErr1 == 1 ){ alert("æœ‰åŠ¹ãªGPXãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“"); return;}
//	mke_KLM();
	let title = writeFilNam + ".kml"; // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
	let linkTag = document.getElementById( "getLocal" );
	let linkTagAttr =  ["href","download"];
	let stringObject = new Blob( [writeTex], { type: "text/plain" } );
	let objectURL = window.URL.createObjectURL( stringObject );   
	linkTag.setAttribute( linkTagAttr[0], objectURL );
	linkTag.setAttribute( linkTagAttr[1], title ); 
}


// WPä»˜GPXèª­ã¿è¾¼ã¿æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆä½œæˆ(v20)
function make_Wplist(entStr){
	WpList = [], pointer = 0;
	let nnn = 0;
	do{
		nnn++; if (nnn > 50) {break;} // ç•°å¸¸æ™‚ãƒ«ãƒ¼ãƒ—è„±å‡º
		pointer = entStr.indexOf("<wpt", pointer);
		if ( pointer != -1 ){
			let Latpt = entStr.indexOf( "lat=",  pointer);
			let Lonpt = entStr.indexOf( "lon=", pointer );
			let LatStr = entStr.substring( Latpt+5, entStr.indexOf('"', Latpt + 5) );
			let LonStr = entStr.substring( Lonpt+5, entStr.indexOf('"', Lonpt + 5) );
			let nameStr = entStr.substring( entStr.indexOf( "<name>", pointer  ) + 6, entStr.indexOf( "</name>", pointer  ) );
			WpList.push( [nameStr, LatStr, LonStr] );
			pointer = Lonpt;
		}
	} while ( pointer != -1 );
}

// ãƒ¤ãƒãƒ¬ã‚³åœ°åä»˜GPXèª­ã¿è¾¼ã¿æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆä½œæˆ(v20)
function make_Wplist_byYR(entStr){
	if ( WpList.length != 0 ){ return; }
	WpList = [];	pointer = 0;	let nnn = 0;
	while ( nnn < 100 ){
		pointer = entStr.indexOf("<trkpt",pointer);
		if (pointer === -1){ break; }
		let trkptStr = entStr.substring(pointer, entStr.indexOf("</trkpt>",pointer)+8);
		if ( trkptStr.indexOf("<name>") != -1 ){
			let Latpt = trkptStr.indexOf("lat=");
			let Lonpt = trkptStr.indexOf("lon=");
			let strLat = trkptStr.substring( Latpt+5, trkptStr.indexOf('"', Latpt+5) );
			let strLon = trkptStr.substring( Lonpt+5, trkptStr.indexOf('"', Lonpt+5) );
			let strName = trkptStr.substring(trkptStr.indexOf("<name>")+6, trkptStr.indexOf("</name>"));
			strName = strName.split("[")[0]; // èª­ã¿ä»®åã‚«ãƒƒãƒˆ
			let dupNameFlg = 0;
		 	for ( let i = 0; i < WpList.length ; i++ ){ if ( WpList[ i ][0] ===  strName ){ dupNameFlg = 1; } }
			if ( dupNameFlg === 0 ){ WpList.push( [ strName, parseFloat(strLat), parseFloat(strLon) ] ); }
			nnn++;
		}
		pointer ++;
	}
}


</script>
</body>
</html>
